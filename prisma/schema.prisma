// Prisma schema for MT5 Smart Money Trading Bot
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Trading signals generated by the bot
model Signal {
  id            String   @id @default(uuid())
  symbol        String
  direction     String   // BUY or SELL
  strategy      String   // ORDER_BLOCK, LIQUIDITY_SWEEP, BOS
  timeframe     String   // M15, H1, H4
  entryPrice    Float
  stopLoss      Float
  takeProfit    Float
  confidence    Float    // 0-1 confidence score
  status        String   // PENDING, TAKEN, REJECTED, EXPIRED
  reason        String?  // Why signal was generated or rejected
  htfBias       String   // Bullish or Bearish from H4
  mtfStructure  String   // Market structure from H1
  createdAt     DateTime @default(now())
  expiresAt     DateTime?
  trade         Trade?

  @@index([symbol])
  @@index([status])
  @@index([createdAt])
}

// Executed trades
model Trade {
  id              String    @id @default(uuid())
  signalId        String?   @unique
  signal          Signal?   @relation(fields: [signalId], references: [id])
  symbol          String
  direction       String    // BUY or SELL
  strategy        String
  entryPrice      Float
  stopLoss        Float
  takeProfit      Float
  lotSize         Float
  openTime        DateTime  @default(now())
  closeTime       DateTime?
  closePrice      Float?
  pnl             Float?
  pnlPercent      Float?
  status          String    // OPEN, CLOSED, CANCELLED
  mt5OrderId      String?
  mt5PositionId   String?
  riskAmount      Float
  riskRewardRatio Float
  notes           String?

  @@index([symbol])
  @@index([status])
  @@index([openTime])
}

// Backtest results
model BacktestResult {
  id              String   @id @default(uuid())
  strategy        String
  symbol          String
  startDate       DateTime
  endDate         DateTime
  initialBalance  Float
  finalBalance    Float
  totalTrades     Int
  winningTrades   Int
  losingTrades    Int
  winRate         Float
  profitFactor    Float
  maxDrawdown     Float
  maxDrawdownPct  Float
  sharpeRatio     Float
  averageWin      Float
  averageLoss     Float
  averageRR       Float
  totalPnl        Float
  totalPnlPct     Float
  createdAt       DateTime @default(now())
  trades          BacktestTrade[]

  @@index([strategy])
  @@index([symbol])
  @@index([createdAt])
}

// Individual trades from backtests
model BacktestTrade {
  id              String   @id @default(uuid())
  backtestId      String
  backtest        BacktestResult @relation(fields: [backtestId], references: [id], onDelete: Cascade)
  symbol          String
  direction       String
  entryPrice      Float
  exitPrice       Float
  stopLoss        Float
  takeProfit      Float
  lotSize         Float
  entryTime       DateTime
  exitTime        DateTime
  pnl             Float
  pnlPercent      Float
  isWinner        Boolean
  exitReason      String   // TP, SL, SIGNAL

  @@index([backtestId])
}

// Account snapshots for tracking equity curve
model AccountSnapshot {
  id        String   @id @default(uuid())
  balance   Float
  equity    Float
  margin    Float
  freeMargin Float
  openPnl   Float
  timestamp DateTime @default(now())

  @@index([timestamp])
}

// Bot configuration and state
model BotState {
  id            String   @id @default("singleton")
  isRunning     Boolean  @default(false)
  startedAt     DateTime?
  lastHeartbeat DateTime?
  activeSymbols String   // Comma-separated list
  config        String   // JSON config
  updatedAt     DateTime @updatedAt
}

// Order blocks identified by the analysis engine
model OrderBlock {
  id            String   @id @default(uuid())
  symbol        String
  timeframe     String
  type          String   // BULLISH or BEARISH
  highPrice     Float
  lowPrice      Float
  openPrice     Float
  closePrice    Float
  candleTime    DateTime
  isValid       Boolean  @default(true)
  mitigatedAt   DateTime?
  createdAt     DateTime @default(now())

  @@index([symbol, timeframe])
  @@index([isValid])
}

// Fair Value Gaps
model FairValueGap {
  id            String   @id @default(uuid())
  symbol        String
  timeframe     String
  type          String   // BULLISH or BEARISH
  highPrice     Float
  lowPrice      Float
  gapTime       DateTime
  isFilled      Boolean  @default(false)
  filledAt      DateTime?
  createdAt     DateTime @default(now())

  @@index([symbol, timeframe])
  @@index([isFilled])
}

// Liquidity zones (swing highs/lows)
model LiquidityZone {
  id            String   @id @default(uuid())
  symbol        String
  timeframe     String
  type          String   // HIGH or LOW
  price         Float
  candleTime    DateTime
  isSwept       Boolean  @default(false)
  sweptAt       DateTime?
  createdAt     DateTime @default(now())

  @@index([symbol, timeframe])
  @@index([isSwept])
}

// Cached historical candle data to reduce API calls
model CachedCandle {
  id        String   @id @default(uuid())
  symbol    String
  timeframe String
  time      DateTime
  open      Float
  high      Float
  low       Float
  close     Float
  volume    Float
  fetchedAt DateTime @default(now())

  @@unique([symbol, timeframe, time])
  @@index([symbol, timeframe, time])
}

// Daily drawdown tracking per symbol
model DailyDrawdown {
  id            String   @id @default(uuid())
  symbol        String
  date          DateTime @db.Date
  startBalance  Float
  currentLoss   Float    @default(0)
  maxLoss       Float    @default(0)
  isLocked      Boolean  @default(false)
  lockReason    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([symbol, date])
  @@index([symbol, date])
}

// Strategy profile configuration history
model StrategyConfig {
  id              String   @id @default(uuid())
  profileName     String
  liveTrading     Boolean  @default(false)
  symbols         String   // JSON array
  settings        String   // JSON config
  activatedAt     DateTime @default(now())
  deactivatedAt   DateTime?
  isActive        Boolean  @default(true)

  @@index([isActive])
  @@index([activatedAt])
}

// Daily market analysis using Claude AI
model MarketAnalysis {
  id                 String   @id @default(uuid())
  analysisDate       DateTime @default(now())
  weekStartDate      DateTime // Start of the week being analyzed
  weekEndDate        DateTime // End of the week being analyzed
  marketNews         String   @db.Text // Summary of key market news considered
  analysis           String   @db.Text // Claude's full analysis
  likelyOutcome      String   @db.Text // Most likely market outcome
  tradeRecommendation String  // RECOMMENDED, NOT_RECOMMENDED, NEUTRAL
  recommendedSymbols String?  // JSON array of symbols if trade recommended
  confidence         Float?   // Confidence score 0-1
  reasoning          String?  @db.Text // Reasoning for the recommendation
  sentToTelegram     Boolean  @default(false)
  telegramSentAt     DateTime?
  createdAt          DateTime @default(now())

  @@index([analysisDate])
  @@index([weekStartDate])
  @@index([sentToTelegram])
}
