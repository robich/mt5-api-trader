// Prisma schema for MT5 Smart Money Trading Bot
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Trading signals generated by the bot
model Signal {
  id            String   @id @default(uuid())
  symbol        String
  direction     String   // BUY or SELL
  strategy      String   // ORDER_BLOCK, LIQUIDITY_SWEEP, BOS
  timeframe     String   // M15, H1, H4
  entryPrice    Float
  stopLoss      Float
  takeProfit    Float
  confidence    Float    // 0-1 confidence score
  status        String   // PENDING, TAKEN, REJECTED, EXPIRED
  reason        String?  // Why signal was generated or rejected
  htfBias       String   // Bullish or Bearish from H4
  mtfStructure  String   // Market structure from H1
  createdAt     DateTime @default(now())
  expiresAt     DateTime?
  trade         Trade?

  @@index([symbol])
  @@index([status])
  @@index([createdAt])
}

// Executed trades
model Trade {
  id              String    @id @default(uuid())
  signalId        String?   @unique
  signal          Signal?   @relation(fields: [signalId], references: [id])
  symbol          String
  direction       String    // BUY or SELL
  strategy        String
  entryPrice      Float
  stopLoss        Float
  takeProfit      Float
  lotSize         Float
  openTime        DateTime  @default(now())
  closeTime       DateTime?
  closePrice      Float?
  pnl             Float?
  pnlPercent      Float?
  status          String    // OPEN, CLOSED, CANCELLED
  mt5OrderId      String?
  mt5PositionId   String?
  riskAmount      Float
  riskRewardRatio Float
  notes           String?

  @@index([symbol])
  @@index([status])
  @@index([openTime])
}

// Backtest results
model BacktestResult {
  id              String   @id @default(uuid())
  strategy        String
  symbol          String
  startDate       DateTime
  endDate         DateTime
  initialBalance  Float
  finalBalance    Float
  totalTrades     Int
  winningTrades   Int
  losingTrades    Int
  winRate         Float
  profitFactor    Float
  maxDrawdown     Float
  maxDrawdownPct  Float
  sharpeRatio     Float
  averageWin      Float
  averageLoss     Float
  averageRR       Float
  totalPnl        Float
  totalPnlPct     Float
  createdAt       DateTime @default(now())
  trades          BacktestTrade[]

  @@index([strategy])
  @@index([symbol])
  @@index([createdAt])
}

// Individual trades from backtests
model BacktestTrade {
  id              String   @id @default(uuid())
  backtestId      String
  backtest        BacktestResult @relation(fields: [backtestId], references: [id], onDelete: Cascade)
  symbol          String
  direction       String
  entryPrice      Float
  exitPrice       Float
  stopLoss        Float
  takeProfit      Float
  lotSize         Float
  entryTime       DateTime
  exitTime        DateTime
  pnl             Float
  pnlPercent      Float
  isWinner        Boolean
  exitReason      String   // TP, SL, SIGNAL

  @@index([backtestId])
}

// Account snapshots for tracking equity curve
model AccountSnapshot {
  id        String   @id @default(uuid())
  balance   Float
  equity    Float
  margin    Float
  freeMargin Float
  openPnl   Float
  timestamp DateTime @default(now())

  @@index([timestamp])
}

// Bot configuration and state
model BotState {
  id            String   @id @default("singleton")
  isRunning     Boolean  @default(false)
  startedAt     DateTime?
  lastHeartbeat DateTime?
  activeSymbols String   // Comma-separated list
  config        String   // JSON config
  updatedAt     DateTime @updatedAt
}

// Order blocks identified by the analysis engine
model OrderBlock {
  id            String   @id @default(uuid())
  symbol        String
  timeframe     String
  type          String   // BULLISH or BEARISH
  highPrice     Float
  lowPrice      Float
  openPrice     Float
  closePrice    Float
  candleTime    DateTime
  isValid       Boolean  @default(true)
  mitigatedAt   DateTime?
  createdAt     DateTime @default(now())

  @@index([symbol, timeframe])
  @@index([isValid])
}

// Fair Value Gaps
model FairValueGap {
  id            String   @id @default(uuid())
  symbol        String
  timeframe     String
  type          String   // BULLISH or BEARISH
  highPrice     Float
  lowPrice      Float
  gapTime       DateTime
  isFilled      Boolean  @default(false)
  filledAt      DateTime?
  createdAt     DateTime @default(now())

  @@index([symbol, timeframe])
  @@index([isFilled])
}

// Liquidity zones (swing highs/lows)
model LiquidityZone {
  id            String   @id @default(uuid())
  symbol        String
  timeframe     String
  type          String   // HIGH or LOW
  price         Float
  candleTime    DateTime
  isSwept       Boolean  @default(false)
  sweptAt       DateTime?
  createdAt     DateTime @default(now())

  @@index([symbol, timeframe])
  @@index([isSwept])
}

// Cached historical candle data to reduce API calls
model CachedCandle {
  id        String   @id @default(uuid())
  symbol    String
  timeframe String
  time      DateTime
  open      Float
  high      Float
  low       Float
  close     Float
  volume    Float
  fetchedAt DateTime @default(now())

  @@unique([symbol, timeframe, time])
  @@index([symbol, timeframe, time])
}

// Daily drawdown tracking per symbol
model DailyDrawdown {
  id            String   @id @default(uuid())
  symbol        String
  date          DateTime @db.Date
  startBalance  Float
  currentLoss   Float    @default(0)
  maxLoss       Float    @default(0)
  isLocked      Boolean  @default(false)
  lockReason    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([symbol, date])
  @@index([symbol, date])
}

// Strategy profile configuration history
model StrategyConfig {
  id              String   @id @default(uuid())
  profileName     String
  liveTrading     Boolean  @default(false)
  symbols         String   // JSON array
  settings        String   // JSON config
  activatedAt     DateTime @default(now())
  deactivatedAt   DateTime?
  isActive        Boolean  @default(true)

  @@index([isActive])
  @@index([activatedAt])
}

// Raw Telegram channel messages
model TelegramChannelMessage {
  id              String   @id @default(uuid())
  telegramMsgId   Int
  channelId       String
  text            String?  @db.Text
  senderName      String?
  hasMedia        Boolean  @default(false)
  rawJson         String?  @db.Text
  receivedAt      DateTime @default(now())
  analysis        TelegramSignalAnalysis?

  @@unique([channelId, telegramMsgId])
  @@index([channelId])
  @@index([receivedAt])
}

// Claude AI analysis of Telegram messages
model TelegramSignalAnalysis {
  id              String   @id @default(uuid())
  messageId       String   @unique
  message         TelegramChannelMessage @relation(fields: [messageId], references: [id])
  category        String   // SIGNAL, TP_UPDATE, SL_UPDATE, CLOSE_SIGNAL, OTHER
  symbol          String?
  direction       String?  // BUY or SELL
  entryPrice      Float?
  stopLoss        Float?
  takeProfit      Float?
  confidence      Float?
  reasoning       String?  @db.Text
  executionStatus String   @default("PENDING") // PENDING, EXECUTED, SKIPPED, FAILED
  executionError  String?  @db.Text
  tradeId         String?  // Link to Trade if executed
  linkedSignalId  String?  // Link to original signal for TP/SL updates
  createdAt       DateTime @default(now())

  @@index([category])
  @@index([executionStatus])
  @@index([createdAt])
}

// Telegram listener state (singleton)
model TelegramListenerState {
  id              String   @id @default("singleton")
  isListening     Boolean  @default(false)
  sessionString   String?  @db.Text
  channelId       String?
  startedAt       DateTime?
  lastMessageAt   DateTime?
  totalMessages   Int      @default(0)
  totalSignals    Int      @default(0)
  totalExecuted   Int      @default(0)
  errorMessage    String?
  updatedAt       DateTime @updatedAt
}

// Analysis scan history (every bot analysis cycle)
model AnalysisScan {
  id               String   @id @default(uuid())
  symbol           String
  currentPrice     Float
  htfBias          String   // BULLISH, BEARISH, NEUTRAL
  mtfBias          String
  ltfBias          String
  confluenceScore  Float    // 0-100
  htfOBCount       Int
  mtfOBCount       Int
  mtfFVGCount      Int
  ltfFVGCount      Int
  htfLiqZoneCount  Int
  mtfLiqZoneCount  Int
  signalGenerated  Boolean  @default(false)
  signalDirection  String?  // BUY or SELL
  signalStrategy   String?  // Strategy name
  signalConfidence Float?   // 0-1
  scannedAt        DateTime @default(now())

  @@index([symbol, scannedAt])
  @@index([scannedAt])
  @@index([signalGenerated])
}

// Strategy Analyst pipeline run history
model StrategyAnalystRun {
  id                 String   @id @default(uuid())
  startedAt          DateTime
  completedAt        DateTime @default(now())
  durationSeconds    Float
  status             String   // SUCCESS, NO_CHANGES, FAILED
  dryRun             Boolean  @default(false)
  failureStep        String?  // Which pipeline step failed
  failureReason      String?  @db.Text
  marketAssessment   String?  @db.Text
  riskAssessment     String?  // LOW, MEDIUM, HIGH
  reasoning          String?  @db.Text  // Claude's full reasoning
  codeChanged        Boolean  @default(false)
  changesProposed    Int      @default(0)
  changesApplied     Int      @default(0)
  changesFailed      Int      @default(0)
  changesDetail      String?  @db.Text  // JSON: [{file, description}]
  backtestBaseline   String?  @db.Text  // JSON: baseline summary per symbol
  backtestValidation String?  @db.Text  // JSON: validation summary per symbol
  backtestPassed     Boolean?
  commitHash         String?
  branch             String?

  @@index([startedAt])
  @@index([status])
}

// Strategy switch log - records every profile change with reason and backtest results
model StrategySwitch {
  id               String   @id @default(uuid())
  symbol           String?  // Null for global switches, or per-symbol
  previousProfile  String   // Profile ID before switch
  newProfile       String   // Profile ID after switch
  reason           String   @db.Text // Why the switch was made
  source           String   // 'manual' | 'analyst' | 'daily-reopt' | 'api'
  backtestPnl      Float?   // New profile's backtest PnL
  backtestWinRate  Float?   // New profile's backtest win rate
  backtestPF       Float?   // New profile's backtest profit factor
  backtestTrades   Int?     // Number of trades in backtest
  backtestMaxDD    Float?   // Max drawdown percentage
  backtestDays     Int?     // Backtest window length in days
  backtestStart    DateTime? // Backtest start date
  backtestEnd      DateTime? // Backtest end date
  previousPnl      Float?   // Previous profile's backtest PnL (for comparison)
  previousWinRate  Float?   // Previous profile's backtest win rate
  previousPF       Float?   // Previous profile's backtest profit factor
  switchedAt       DateTime @default(now())

  @@index([switchedAt])
  @@index([symbol])
  @@index([source])
}

// Manual trigger requests for strategy analyst (DB-based, works across all platforms)
model StrategyAnalystTrigger {
  id          String   @id @default(uuid())
  status      String   @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED
  requestedAt DateTime @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  result      String?  @db.Text // JSON result summary

  @@index([status])
  @@index([requestedAt])
}

// Daily market analysis using Claude AI
model MarketAnalysis {
  id                 String   @id @default(uuid())
  analysisDate       DateTime @default(now())
  weekStartDate      DateTime // Start of the week being analyzed
  weekEndDate        DateTime // End of the week being analyzed
  marketNews         String   @db.Text // Summary of key market news considered
  analysis           String   @db.Text // Claude's full analysis
  likelyOutcome      String   @db.Text // Most likely market outcome
  tradeRecommendation String  // RECOMMENDED, NOT_RECOMMENDED, NEUTRAL
  recommendedSymbols String?  // JSON array of symbols if trade recommended
  confidence         Float?   // Confidence score 0-1
  reasoning          String?  @db.Text // Reasoning for the recommendation
  sentToTelegram     Boolean  @default(false)
  telegramSentAt     DateTime?
  createdAt          DateTime @default(now())

  @@index([analysisDate])
  @@index([weekStartDate])
  @@index([sentToTelegram])
}
